<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- <title>Search for BD_COMPETICAOs:first item's comp_nome - CAMPEÃ GERAL</title> -->
    <title>Relatório GR Code</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/v/bs5/jq-3.7.0/jszip-3.10.1/dt-2.1.7/b-3.1.2/b-colvis-3.1.2/b-html5-3.1.2/b-print-3.1.2/cr-2.0.4/date-1.5.4/fc-5.0.1/fh-4.0.1/kt-2.12.1/r-3.0.3/rg-1.5.0/rr-1.5.0/sc-2.4.3/sb-1.8.0/sp-2.3.2/sl-2.1.0/sr-1.4.1/datatables.min.css"
      rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/v/bs5/jq-3.7.0/jszip-3.10.1/dt-2.1.7/b-3.1.2/b-colvis-3.1.2/b-html5-3.1.2/b-print-3.1.2/cr-2.0.4/date-1.5.4/fc-5.0.1/fh-4.0.1/kt-2.12.1/r-3.0.3/rg-1.5.0/rr-1.5.0/sc-2.4.3/sb-1.8.0/sp-2.3.2/sl-2.1.0/sr-1.4.1/datatables.min.js"></script>

    <!-- Moment Plugins -->
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.4/moment.min.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/plug-ins/1.13.6/sorting/datetime-moment.js"
    ></script>

    <script
      src="https://kit.fontawesome.com/8134bdb3c6.js"
      crossorigin="anonymous"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/plug-ins/1.13.6/filtering/type-based/diacritics-neutralise.js"
    ></script>
    <script
      type="text/javascript"
      src="https://cdn.datatables.net/plug-ins/1.13.6/filtering/type-based/accent-neutralise.js"
    ></script>
  </head>

  <body>
    <div style="display: flex">
      <div class="form-group">
        <label for="select_relatorio">Relatório</label>
        <select disabled value="" id="select_relatorio" class="form-select">
          <option label="" value="">Escolha seu relatório</option>
          <option label="Individual geral" value="GERAL"></option>
          <option label="Individual por aparelho" value="POR_APARELHO"></option>
        </select>
      </div>

      <div class="form-group">
        <label for="select_classe">Classe</label>
        <select value="" id="select_classe" class="form-select">
          <option value="">Escolha sua classe</option>
          <option label="Conjunto" value="CONJUNTO"></option>
          <option label="Dupla" value="DUPLA"></option>
          <option label="Individual" value="INDIVIDUAL"></option>
          <option label="Trio" value="TRIO"></option>
        </select>
      </div>

      <div class="form-group">
        <label for="select_categoria">Categoria</label>
        <select value="" id="select_categoria" class="form-select">
          <option value="">Escolha sua categoria</option>
        </select>
      </div>

      <div class="form-group d-none">
        <label for="select_nivel">Nível</label>
        <select value="" id="select_nivel" class="form-select">
          <option value="">Escolha o nível</option>
        </select>
      </div>
    </div>
    <table
      id="grcode_relatorios_table"
      class="table table-sm table-striped table-hover table-bordered"
    >
      <thead class="table-dark">
        <tr></tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      // https://grdesportiva.bubbleapps.io/version-test/api/1.1/meta/swagger.json

      $(document).ready(function () {
        const ColunaLabels = {
          index: "#",
          nome: "Nome",
          clube: "Clube",
          classe: "Classe",
          categoria_ordem: "Ordem Categoria",
          categoria_descricao: "Categoria Descricao",
          categoria_nome: "Categoria Nome",
          categoria_nivel_group: "Categoria Nivel",
          aparelho: "Aparelho",
          estagio: "Estagio",
          nota_da1: "Nota Da1",
          nota_db1: "Nota Db1",
          nota_tot_dbda: "Dbda",
          nota_tot_exe: "Exe",
          nota_tot_art: "Art",
          nota_tot_ded: "Ded",
          nota_final: "Nota",
        };

        const AparelhoLabels = {
          ARCO: "Arco",
          BOLA: "Bola",
          MAÇAS: "Maças",
          FITA: "Fita",
          "MAOS LIVRES": "Mãos Livres",
          CORDA: "Corda",
        };

        const selectRelatorio = document.querySelector("#select_relatorio");
        const selectClasse = document.querySelector("#select_classe");
        const selectCategoria = document.querySelector("#select_categoria");
        const selectNivel = document.querySelector("#select_nivel");

        const tabelaRelatorio = document.querySelector(
          "#grcode_relatorios_table"
        );

        // const baseUrl = 'Website home URL';
        const baseUrl = "https://codegr.com.br";

        // const slug = 'Get path from page URL';
        const slug = "2024-regional-nordeste-vts";

        let dadosProcessados;
        let categoriaAtual;

        fetch(`${baseUrl}/api/1.1/wf/resultados-individual?slug=${slug}`)
          .then((response) => response.json())
          .then((response) => {
            // TODO loading
            selectRelatorio.disabled = false;
            dadosProcessados = processarDados(response.data);
            console.log(dadosProcessados);
          })
          .catch(console.error);

        selectRelatorio.addEventListener("change", function (event) {
          console.log("Select Relatório:", event.target.value);
          if (!event.target.value) {
            limparSelects();
            return;
          }

          if (!dadosProcessados) {
            return;
          }

          const relatorio = event.target.value;

          if (relatorio === "GERAL") {
            selectNivel.parentElement.classList.remove("d-none");
            // handleRelatorioGeral();
          } else if (relatorio === "POR_APARELHO") {
            selectNivel.parentElement.classList.add("d-none");
            // handleRelatorioPorAparelho();
          }

          const classes = Object.keys(
            relatorio === "GERAL"
              ? dadosProcessados.groupedByCategoriaNivel
              : dadosProcessados.groupedByCategoriaDescricao
          );

          selectClasse.innerHTML = mapToOptions(classes, "Escolha sua classe");
          selectClasse.addEventListener("change", selectClasseEventListener);

          selectCategoria.addEventListener(
            "change",
            selectCategoriaEventListener
          );

          return;
        });

        /** Handle async data */

        /**
         * @typedef {'CONJUNTO' | 'DUPLA' | 'INDIVIDUAL' | 'TRIO'} Classe
         *
         * @typedef {Object} Data
         * @property {string} nome
         * @property {string} clube
         * @property {string} nome
         * @property {string} clube
         * @property {Classe} classe
         * @property {string} categoria_ordem
         * @property {string} categoria_descricao
         * @property {string} categoria_nome
         * @property {string} categoria_nivel_group
         * @property {string} categoria_nivel
         * @property {string} aparelho
         * @property {'FINAL' | 'CLASSIFICATÓRIA'} estagio
         * @property {number} nota_da1
         * @property {number} nota_db1
         * @property {number} nota_tot_dbda
         * @property {number} nota_tot_exe
         * @property {number} nota_tot_art
         * @property {number} nota_tot_ded
         * @property {number} nota_final
         *
         * @param {Data[]} data
         *
         * @typeof {Object} ReturnData
         * @property {Data[]} data
         * @property {Object.<Classe, Object.<string, Data[]>>} groupedByCategoriaNivel
         *
         * @return {ReturnData} dadosProcessados
         */
        function processarDados(data) {
          data.forEach((row) => {
            row.categoria_ordem = Number(row.categoria_ordem);
            row.categoria_nivel = Number(row.categoria_nivel);
          });

          const groupedByClasse = groupByKey(data, "classe");

          const groupedByCategoria = twoLevels(
            groupedByClasse,
            "categoria_nome"
          );

          const groupedByCategoriaNivel = Object.keys(
            groupedByCategoria
          ).reduce((acc, currGroup) => {
            acc[currGroup] = twoLevels(
              groupedByCategoria[currGroup],
              "categoria_nivel"
            );
            return acc;
          }, {});

          const groupedByCategoriaDescricao = twoLevels(
            groupedByClasse,
            "categoria_descricao"
          );

          const ordemCategoriasPorAparelho = {};
          data.forEach((data) => {
            if (!ordemCategoriasPorAparelho[data.categoria_descricao]) {
              ordemCategoriasPorAparelho[data.categoria_descricao] =
                data.categoria_ordem;
            }
          });

          return {
            data,
            groupedByCategoriaNivel,
            groupedByCategoriaDescricao,
            ordemCategoriasPorAparelho,
          };
        }

        function limparTabela() {
          // check if table is already a DataTable instance
          if ($.fn.DataTable.isDataTable("#grcode_relatorios_table")) {
            $("#grcode_relatorios_table").DataTable().destroy();
            $("#grcode_relatorios_table thead tr").empty();
            $("#grcode_relatorios_table tbody").empty();
          }
        }

        function setTableGeral() {
          const classe = selectClasse.value;
          const categoria = selectCategoria.value;
          const nivel = selectNivel.value;

          if (!classe || !categoria || !nivel) {
            return;
          }

          const data =
            dadosProcessados.groupedByCategoriaNivel[classe][categoria][nivel];

          const aparelhos = new Set(data.map((row) => row.aparelho));

          const processedData = Object.keys(groupByKey(data, "nome")).map(
            (nome) => {
              const rows = groupByKey(data, "nome")[nome];
              const nota_total = rows.reduce(
                (acc, row) => acc + row.nota_final,
                0
              );

              return {
                nome,
                clube: rows[0].clube,
                classe: rows[0].classe,
                aparelhos: rows.map((row) => ({
                  aparelho: row.aparelho,
                  nota_tot_dbda: row.nota_tot_dbda,
                  nota_tot_art: row.nota_tot_art,
                  nota_tot_exe: row.nota_tot_exe,
                  nota_tot_ded: row.nota_tot_ded,
                  nota_final: row.nota_final,
                })),
                nota_total,
              };
            }
          );

          console.log({
            data,
            rows: groupByKey(data, "nome"),
            processedData,
          });

          // TODO Adicionar imagem dos aparelhos?
          const tableHeader = tabelaRelatorio.querySelector("thead");
          const colunas = [
            "index",
            "nome",
            "clube",
            "classe",
            ...[aparelhos].map((aparelho) => [
              `nota_tot_dbda_${aparelho}`,
              `nota_tot_art_${aparelho}`,
              `nota_tot_exe_${aparelho}`,
              `nota_tot_ded_${aparelho}`,
              `nota_final_${aparelho}`,
            ]),
            "nota_final",
          ];

          tableHeader.innerHTML = `
            <tr>
              <th rowspan="2" class="align-middle">#</th>
              <th rowspan="2" class="align-middle">Nome</th>
              <th rowspan="2" class="align-middle">Clube</th>
              <th rowspan="2" class="align-middle">Classe</th>
              ${[...aparelhos]
                .map(
                  (aparelho) =>
                    `<th colspan="5" data-dt-order="disable" class="text-center">${AparelhoLabels[aparelho]}</th>`
                )
                .join("")}
              <th rowspan="2" class="align-middle">Nota Total</th>
            </tr>
            <tr>
              ${[...aparelhos]
                .map(
                  () =>
                    `
                      <th data-dt-order="disable">D</th>
                      <th data-dt-order="disable">A</th>
                      <th data-dt-order="disable">E</th>
                      <th data-dt-order="disable">Ded</th>
                      <th>Tot</th>
                    `
                )
                .join("")}
            </tr>
          `;

          const tbody = tabelaRelatorio.querySelector("tbody");

          // TODO: sort by aparelhos tbm, soma da execução
          processedData.sort((a, b) => b.nota_total - a.nota_total);

          // TODO: Tratar atletas que não tem os 2 aparelhos
          processedData.forEach((data, index) => {
            data.index = index + 1;
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${data.index}</td>
              <td>${data.nome}</td>
              <td>${data.clube}</td>
              <td>${data.classe}</td>
              ${data.aparelhos
                .map(
                  (aparelho) => `
                  <td class="text-end text-nowrap">${formatNumber(
                    aparelho.nota_tot_dbda
                  )}</td>
                  <td class="text-end text-nowrap">${formatNumber(
                    aparelho.nota_tot_art
                  )}</td>
                  <td class="text-end text-nowrap">${formatNumber(
                    aparelho.nota_tot_exe
                  )}</td>
                  <td class="text-end text-nowrap">${formatNumber(
                    aparelho.nota_tot_ded
                  )}</td>
                  <td class="text-end text-nowrap">${formatNumber(
                    aparelho.nota_final
                  )}</td>
                `
                )
                .join("")}
              <td class="text-end text-nowrap">${formatNumber(
                data.nota_total
              )}</td>
            `;
            tbody.appendChild(row);
          });

          // // check if table is already a DataTable instance
          recarregarDataTables(colunas);
        }

        function formatNumber(value) {
          return typeof value === "number" ? value.toFixed(2) : value;
        }

        function setTablePorAparelho() {
          const classe = selectClasse.value;
          const categoria = categoriaAtual;

          if (!classe || !categoria) {
            return;
          }

          // id, nome, clube, aparelho, nota_tot_dbda, nota_tot_art, nota_tot_exe, nota_tot_ded, nota_final
          // create columns in the table header for the columns above. Use the Colunas object to get the column names
          const colunas = [
            "index",
            "nome",
            "clube",
            "aparelho",
            "nota_tot_dbda",
            "nota_tot_art",
            "nota_tot_exe",
            "nota_tot_ded",
            "nota_final",
          ];

          const numberColumns = new Set([
            "nota_tot_dbda",
            "nota_tot_art",
            "nota_tot_exe",
            "nota_tot_ded",
            "nota_final",
          ]);

          colunas.forEach((coluna) => {
            const th = document.createElement("th");
            th.textContent = ColunaLabels[coluna];
            tableHeader.appendChild(th);
          });

          const dados =
            dadosProcessados.groupedByCategoriaDescricao[classe][categoria];

          dados.sort(sortData);
          dados.forEach(populateData(dados, colunas));

          recarregarDataTables(colunas);
        }

        function sortData(a, b) {
          if (b.nota_final === a.nota_final) {
            return b.nota_tot_exe - a.nota_tot_exe;
          }

          return b.nota_final - a.nota_final;
        }

        function populateData(dados, colunas) {
          return function (data, index) {
            data.index = index + 1;
            const row = document.createElement("tr");
            colunas.forEach((coluna) => {
              const cell = document.createElement("td");
              const cellData = data[coluna];

              if (numberColumns.has(coluna)) {
                cell.classList.add("text-end");
                cell.classList.add("text-nowrap");
                cell.textContent = formatNumber(cellData);
              } else {
                cell.textContent = cellData;
              }

              row.appendChild(cell);
            });

            tabelaRelatorio.querySelector("tbody").appendChild(row);
          };
        }
        /** Handle async data */

        function recarregarDataTables(colunas) {
          console.log(
            "Recarregando DataTables para categoria:",
            categoriaAtual
          );

          $("#grcode_relatorios_table").DataTable({
            ordering: true,
            keys: true,
            fixedHeader: true,
            paging: false,
            order: [
              [colunas.length - 1, "desc"],
              // [colunas.length - 3, "desc"],
            ],
            layout: {
              topStart: "buttons",
              topEnd: "search",
              bottomStart: "info",
              bottomEnd: "paging",
            },
            language: {
              url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/pt-BR.json",

              // datetime: {
              //   weekdays: ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"],
              // },
            },
            buttons: [
              {
                extend: "excelHtml5",
                text: '<i class="fas fa-file-excel"></i> ',
                titleAttr: "Exportar a Excel",
                autoFilter: true,
                className: "btn btn-success",
                exportOptions: {
                  columns: ":visible",
                },
              },
              {
                extend: "pdfHtml5",
                text: '<i class="fa-solid fa-file-pdf"></i> ',
                titleAttr: "Exportar para PDF",
                orientation: "landscape",
                className: "btn btn-danger",
                exportOptions: {
                  columns: ":visible",
                },
              },
              {
                extend: "print",
                text: '<i class="fa fa-print"></i> ',
                titleAttr: "Imprimir",
                className: "btn btn-info",
                exportOptions: {
                  columns: ":visible",
                },
              },
              {
                extend: "csv",
                text: '<i class="fa-solid fa-file-csv"></i> ',
                titleAttr: "Exportar para CSV",
                charset: "utf-8",
                fieldSeparator: ";",
                fieldBoundary: "",
                bom: true,
                className: "btn btn-success",
                exportOptions: {
                  columns: ":visible",
                  stripHtml: false,
                },
              },
            ],
          });
        }

        /** Handle Selects */

        function limparSelects() {
          selectRelatorio.value = "";
          selectClasse.innerHTML = selectClasse.children[0].outerHTML;
          selectCategoria.innerHTML = selectCategoria.children[0].outerHTML;
          selectNivel.innerHTML = selectNivel.children[0].outerHTML;

          selectClasse.removeEventListener(selectClasseEventListener);
          selectCategoria.removeEventListener(selectCategoriaEventListener);
          selectNivel.removeEventListener(selectNivelEventListener);
        }

        function setCategoriaOptions() {
          const relatorio = selectRelatorio.value;
          const classe = selectClasse.value;
          if (!relatorio || !classe) return;

          let categorias;
          if (relatorio === "GERAL") {
            categorias = Object.keys(
              dadosProcessados.groupedByCategoriaNivel[classe]
            );
          } else if (relatorio === "POR_APARELHO") {
            categorias = Object.keys(
              dadosProcessados.groupedByCategoriaDescricao[classe]
            );
            categorias.sort((a, b) => {
              return (
                dadosProcessados.ordemCategoriasPorAparelho[a] -
                dadosProcessados.ordemCategoriasPorAparelho[b]
              );
            });
          }

          if (!categorias) return;

          selectCategoria.innerHTML = mapToOptions(
            categorias,
            "Escolha sua categoria"
          );
        }

        function selectClasseEventListener(event) {
          if (!dadosProcessados) {
            return;
          }

          setCategoriaOptions();
        }

        function selectCategoriaEventListener(event) {
          console.log({ categoriaAtual, nova: event.target.value });
          if (event.target.value && categoriaAtual !== event.target.value) {
            categoriaAtual = event.target.value;
            const relatorio = selectRelatorio.value;
            if (!!relatorio && relatorio === "POR_APARELHO") {
              limparTabela();
              setTablePorAparelho();
            } else if (!!relatorio && relatorio === "GERAL") {
              const niveis = Object.keys(
                dadosProcessados.groupedByCategoriaNivel[selectClasse.value][
                  categoriaAtual
                ]
              );

              selectNivel.innerHTML = mapToOptions(niveis, "Escolha o nível");
              selectNivel.addEventListener("change", selectNivelEventListener);
            }
          }
        }

        function selectNivelEventListener(event) {
          if (event.target.value) {
            limparTabela();
            setTableGeral();
          }
        }
      });

      function mapToOptions(options, defaultLabel) {
        return `<option value="">${defaultLabel}</option>${options
          .map((option) => `<option value="${option}">${option}</option>`)
          .join("")}`;
      }

      /**
       * @param {Data[]} array
       * @param {keyof Data} key
       * @returns {Object.<keyof Data, Data[]>}
       */
      function groupByKey(array, key) {
        return array.reduce((acc, item) => {
          if (!acc[item[key]]) {
            acc[item[key]] = [];
          }

          acc[item[key]].push(item);

          return acc;
        }, {});
      }

      function twoLevels(groupBy, key) {
        return Object.keys(groupBy).reduce((acc, currGroup) => {
          acc[currGroup] = groupByKey(groupBy[currGroup], key);
          return acc;
        }, {});
      }
    </script>
  </body>
</html>
